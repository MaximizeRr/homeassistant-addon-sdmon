---
stages:
  - lint
  - build
  - publish

# Lint stage - validate addon configuration
lint:
  stage: lint
  image: homeassistant/amd64-builder:latest
  before_script:
    - apk add --no-cache jq yq
  script:
    - |
      echo "Validating addon configuration files..."

      # Validate YAML syntax
      yq eval '.' sdmon/config.yaml > /dev/null
      yq eval '.' sdmon/build.yaml > /dev/null
      yq eval '.' repository.yaml > /dev/null

      # Validate JSON structure in config
      echo "Configuration validation passed"
  only:
    - merge_requests
    - main

# Build stage - build the addon for all architectures
.build_template: &build_template
  stage: build
  image: homeassistant/${ARCH}-builder:latest
  variables:
    DOCKER_DRIVER: overlay2
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - |
      docker build \
        --build-arg BUILD_FROM="$(cat sdmon/build.yaml | grep ${ARCH} | cut -d'"' -f2)" \
        --build-arg BUILD_ARCH="${ARCH}" \
        --build-arg SDMON_VERSION="$(cat sdmon/build.yaml | grep SDMON_VERSION | cut -d'"' -f2)" \
        -t "${CI_REGISTRY_IMAGE}/${ARCH}-addon-sdmon:${CI_COMMIT_REF_SLUG}" \
        -f sdmon/Dockerfile \
        sdmon/
  only:
    - main
    - tags

build:aarch64:
  <<: *build_template
  variables:
    ARCH: aarch64

build:amd64:
  <<: *build_template
  variables:
    ARCH: amd64

build:armhf:
  <<: *build_template
  variables:
    ARCH: armhf

build:armv7:
  <<: *build_template
  variables:
    ARCH: armv7

build:i386:
  <<: *build_template
  variables:
    ARCH: i386

# Publish stage - only on tags
publish:
  stage: publish
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - |
      echo "Add-on build and publish completed"
      echo "Version: ${CI_COMMIT_TAG}"
  only:
    - tags
  dependencies: []
