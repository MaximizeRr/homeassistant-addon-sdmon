# Last Modified: Oct 14, 2025
# AppArmor profile for sdmon add-on
#
# This profile is designed to confine the sdmon add-on, which reads
# health information from SD cards using low-level ioctl commands.
#

#include <tunables/global>

profile sdmon flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>

  # Capabilities
  file,
  signal (send) set=(kill,term,int,hup,cont),

  # S6-Overlay
  /init ix,
  /bin/** ix,
  /usr/bin/** ix,
  /usr/local/bin/** ix,
  /run/{s6,s6-rc*,service}/** ix,
  /package/** ix,
  /command/** ix,
  /etc/services.d/** rwix,
  /etc/cont-init.d/** rwix,
  /etc/cont-finish.d/** rwix,
  /run/{,**} rwk,
  /dev/tty rw,

  # Bashio
  /usr/lib/bashio/** ix,
  /tmp/** rwk,

  # Networking for Home Assistant API
  network inet stream,
  network inet6 stream,

  # Access to options.json and other files within your addon
  /data/** rw,

  # Access to mapped volumes specified in config.json
  /share/** rw,

  # Device access for SD card monitoring
  /dev/mmcblk[0-9]* rw,
  /sys/block/mmcblk*/** r,
  /sys/devices/** r,

  # Home Assistant sensor update script
  /usr/local/bin/update-ha-sensors.sh rix,

  # Start new profile for sdmon binary
  /usr/local/bin/sdmon cx -> sdmon_binary,

  profile sdmon flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>

    # Receive signals from S6-Overlay
    signal (receive) peer=*_sdmon,

    # This is the most critical permission. The program uses the
    # ioctl(MMC_IOC_CMD) system call to send raw commands directly
    # to the SD card controller. This requires CAP_SYS_RAWIO.
    capability sys_rawio,

    # Access to options.json and other files within your addon
    /data/** rw,

    # Access to mapped volumes specified in config.json
    /share/** rw,

    # The executable needs to be read and mapped into memory
    /usr/local/bin/sdmon mr,

    # The program needs read and write access to the mmc block device
    # Using a wildcard allows it to work with any SD card reader
    /dev/mmcblk[0-9]* rw,

    # System information needed for SD card detection
    /sys/block/mmcblk*/** r,
    /sys/devices/** r,
    /sys/class/block/** r,

    # System files needed
    /bin/bash rix,
    /bin/echo ix,
    /bin/grep ix,
    /bin/sleep ix,
    /etc/passwd r,
    /dev/tty rw,

    # Proc filesystem for device information
    /proc/sys/kernel/random/boot_id r,
    /proc/sys/kernel/osrelease r,
  }
}
